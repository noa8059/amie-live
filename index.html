<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <title>è’¼é‡ï¼šè¶…é™½æ˜¥é–‹åœ˜ç³»çµ±</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:"Segoe UI",Tahoma,sans-serif;background:#f0f2f5;color:#333;padding:2rem;display:flex;justify-content:center;}
    .container{width:100%;max-width:600px;background:#fff;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.05);overflow:hidden;}
    header{background:#4a90e2;color:#fff;text-align:center;padding:1.5rem;}
    header h1{font-size:1.5rem;letter-spacing:1px;}
    main{padding:1.5rem;}
    h2,h3{margin-bottom:0.75rem;color:#4a90e2;}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:0.5rem;margin-bottom:1rem;}
    .grid label{display:flex;flex-direction:column;background:#fafafa;padding:0.75rem;border:1px solid #ececec;border-radius:4px;font-size:0.9rem;text-align:center;}
    .grid input[type="number"]{margin-top:0.5rem;padding:0.4rem;font-size:1rem;width:100%;}
    .remain{margin-top:0.25rem;font-size:0.8rem;color:#888;}
    .field{margin-bottom:1rem;}
    .field input{width:100%;padding:0.75rem;font-size:1rem;border:1px solid #ccc;border-radius:4px;}
    button{width:100%;padding:0.75rem;background:#4a90e2;color:#fff;font-size:1rem;border:none;border-radius:4px;cursor:pointer;margin-top:0.5rem;}
    button:hover{background:#357ab8;}
    #message{margin-top:1rem;text-align:center;font-weight:bold;color:#e67e22;}
    table{width:100%;border-collapse:collapse;margin-bottom:1rem;}
    th,td{border:1px solid #ddd;padding:0.5rem;text-align:center;}
    th{background:#f7f9fc;}
    #orders div{padding:0.75rem;border:1px solid #ececec;border-radius:4px;margin-bottom:0.5rem;background:#fafafa;font-size:0.9rem;}
  </style>
</head>
<body>
  <div class="container">
    <header><h1>è’¼é‡ï¼šè¶…é™½æ˜¥é–‹åœ˜ç³»çµ±</h1></header>
    <main><div id="root">è¼‰å…¥ä¸­...</div></main>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // è¯·æ›¿æ¢æˆä½ éƒ¨ç½²çš„ Apps Script exec URLï¼ˆä¸è¦å¸¦ <>ï¼‰
    const API = "https://script.google.com/macros/s/AKfycbzooA4iBnHRgL4DxCXcm54DuDpVW6obyyxl4zxC8HijF9wJmLxzL-ztvfz6a_o6equK/exec";
    const roles = ["27","R","18","69"];
    const state = { submitted: [] };

    // 1. è¯»æ—¢æœ‰è®¢å•
    fetch(API)
      .then(res => res.json())
      .then(data => {
        state.submitted = data.map(o => ({
          name: o.Name,
          contact: o.Contact,
          badge: { "27":+o.Badge_27, "R":+o.Badge_R, "18":+o.Badge_18, "69":+o.Badge_69 },
          acrylic: { "27":+o.Acrylic_27, "R":+o.Acrylic_R, "18":+o.Acrylic_18, "69":+o.Acrylic_69 }
        }));
        render();
      });

    function computeRemaining() {
      const rem = { badge: {}, acrylic: {} };
      roles.forEach(r => { rem.badge[r] = 4; rem.acrylic[r] = 2; });
      state.submitted.forEach(o => {
        roles.forEach(r => {
          rem.badge[r] -= o.badge[r] || 0;
          rem.acrylic[r] -= o.acrylic[r] || 0;
        });
      });
      return rem;
    }

    function render() {
      const rem = computeRemaining();
      let html = `<h2>ç›®å‰ä¸‹å–®ç‹€æ³</h2>
        <table><thead>
          <tr><th>è§’è‰²</th><th>å¾½ç« å‰©é¤˜</th><th>å£“å…‹åŠ›å¡å‰©é¤˜</th></tr>
        </thead><tbody>`;
      roles.forEach(r => {
        html += `<tr><td>${r}</td><td>${rem.badge[r]}</td><td>${rem.acrylic[r]}</td></tr>`;
      });
      html += `</tbody></table>`;

      html += `<h2>Amie ç³»åˆ—ä»£è³¼</h2>
        <div class="field"><input id="name" type="text" placeholder="æš±ç¨±" /></div>
        <div class="field"><input id="contact" type="text" placeholder="å™—æµªå¸³è™Ÿæˆ–è‡‰æ›¸ç¶²å€" /></div>
        <h3>å¾½ç« ï¼ˆ140å…ƒï¼‰</h3>
        <div class="grid">` +
          roles.map(r => `
            <label>${r}
              <input type="number" min="0" id="badge-${r}" value="0" />
              <span class="remain">å‰©é¤˜ ${rem.badge[r]}</span>
            </label>`).join("") +
        `</div>
        <h3>å£“å…‹åŠ›å¡ï¼ˆ145å…ƒï¼‰</h3>
        <div class="grid">` +
          roles.map(r => `
            <label>${r}
              <input type="number" min="0" id="acrylic-${r}" value="0" />
              <span class="remain">å‰©é¤˜ ${rem.acrylic[r]}</span>
            </label>`).join("") +
        `</div>
        <button id="submit">æˆ‘è¦å–Šå–®</button>
        <div id="message"></div>
        <hr/>
        <h3>ğŸ“¦ å–Šå–®ç´€éŒ„</h3>
        <div id="orders"></div>`;

      document.getElementById("root").innerHTML = html;

      document.getElementById("submit").onclick = () => {
        if (!confirm("æ˜¯å¦ç¢ºèªå–Šå–®ï¼Ÿ")) return;
        const name = document.getElementById("name").value.trim();
        const contact = document.getElementById("contact").value.trim();
        const badge = {}, acrylic = {};
        roles.forEach(r => {
          badge[r] = parseInt(document.getElementById("badge-"+r).value) || 0;
          acrylic[r] = parseInt(document.getElementById("acrylic-"+r).value) || 0;
        });
        if ((badge["18"]||badge["27"]||acrylic["18"]||acrylic["27"])
            && !confirm("âš ï¸ æ‚¨é¸æ“‡äº†ç†±é–€è§’è‰²ï¼Œå¯èƒ½éœ€è¦ç¶è§’ï¼Œè‹¥éœ€ç¶è§’å°‡å¦è¡Œé€šçŸ¥ã€‚ä»è¦å–Šå–®å—ï¼Ÿ"))
          return;

        // 2. POST æ–°è¨‚å–®
        fetch(API, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, contact, badge, acrylic })
        })
        .then(() => alert("âœ… å–Šå–®æˆåŠŸï¼"))
        .then(() => {
          state.submitted.push({ name, contact, badge, acrylic });
          render();
          renderOrders();
        });
      };
    }

    function renderOrders() {
      const c = document.getElementById("orders");
      c.innerHTML = state.submitted.map(o => `
        <div><strong>${o.name}</strong>ï¼ˆ${o.contact}ï¼‰<br/>
          å¾½ç« ï¼š${JSON.stringify(o.badge)}<br/>
          å£“å…‹åŠ›å¡ï¼š${JSON.stringify(o.acrylic)}</div>`
      ).join("");
    }
  });
  </script>
</body>
</html>
